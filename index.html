<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>BudgetWise</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=IBM+Plex+Mono:wght@300;400;500&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg:#0a0a0a;--surface:#111;--surface2:#1a1a1a;--surface3:#222;--surface4:#2a2a2a;
  --border:#2a2a2a;--border2:#333;--border3:#3a3a3a;
  --text:#f0f0f0;--text2:#999;--text3:#666;--white:#fff;
  --green:#4ade80;--red:#f87171;--blue:#60a5fa;--yellow:#fbbf24;--purple:#c084fc;
  --radius:12px;--radius-sm:8px;
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'Syne',sans-serif;font-size:15px;}
body{display:flex;flex-direction:column;min-height:100vh;}
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
header{display:flex;align-items:center;justify-content:space-between;padding:18px 32px;border-bottom:1px solid var(--border);position:sticky;top:0;background:rgba(10,10,10,0.94);backdrop-filter:blur(20px);z-index:100;}
.logo{font-size:1.1rem;font-weight:800;letter-spacing:-.02em;color:var(--white);}
.logo span{color:var(--text3);}
nav{display:flex;gap:4px;}
nav button{background:none;border:none;color:var(--text2);font-family:'Syne',sans-serif;font-size:.78rem;font-weight:600;letter-spacing:.08em;text-transform:uppercase;padding:8px 14px;border-radius:var(--radius-sm);cursor:pointer;transition:all .2s;}
nav button:hover{color:var(--text);background:var(--surface2);}
nav button.active{color:var(--white);background:var(--surface3);}
main{flex:1;padding:28px 32px;max-width:1280px;width:100%;margin:0 auto;}
.page{display:none;animation:fadeIn .3s ease;}
.page.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.section-title{font-size:1.5rem;font-weight:800;letter-spacing:-.03em;margin-bottom:5px;}
.section-sub{color:var(--text3);font-family:'IBM Plex Mono',monospace;font-size:.72rem;margin-bottom:24px;}
/* BALANCE BAR */
.balance-bar{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px 28px;margin-bottom:20px;display:flex;align-items:center;gap:32px;flex-wrap:wrap;}
.balance-main{display:flex;flex-direction:column;gap:4px;}
.balance-label{font-family:'IBM Plex Mono',monospace;font-size:.7rem;color:var(--text3);letter-spacing:.1em;text-transform:uppercase;}
.balance-amount{font-size:2.2rem;font-weight:800;letter-spacing:-.04em;color:var(--white);}
.balance-amount.green{color:var(--green);}
.balance-amount.red{color:var(--red);}
.balance-note{font-family:'IBM Plex Mono',monospace;font-size:.63rem;color:var(--text3);margin-top:2px;}
.balance-sep{width:1px;height:40px;background:var(--border2);flex-shrink:0;}
.balance-meta{display:flex;flex-direction:column;gap:3px;}
.balance-meta-row{font-family:'IBM Plex Mono',monospace;font-size:.72rem;color:var(--text2);}
.balance-meta-row span{color:var(--text);}
.balance-input-wrap{margin-left:auto;display:flex;align-items:center;gap:10px;}
.balance-input-pre{position:relative;display:flex;align-items:center;}
.balance-input-pre::before{content:'$';position:absolute;left:9px;color:var(--text3);font-family:'IBM Plex Mono',monospace;font-size:.82rem;z-index:1;}
.balance-input{width:160px;background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);padding:9px 12px 9px 22px;color:var(--text);font-family:'IBM Plex Mono',monospace;font-size:.88rem;outline:none;transition:border-color .2s;}
.balance-input:focus{border-color:var(--text3);}
.set-balance-btn{background:var(--white);color:var(--bg);border:none;border-radius:var(--radius-sm);padding:9px 16px;font-family:'Syne',sans-serif;font-size:.8rem;font-weight:700;cursor:pointer;transition:opacity .2s;white-space:nowrap;}
.set-balance-btn:hover{opacity:.85;}
/* MONTH PROGRESS */
.month-progress-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px 24px;margin-bottom:20px;}
.mp-header{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:12px;}
.mp-title{font-size:.95rem;font-weight:700;}
.mp-pct{font-family:'IBM Plex Mono',monospace;font-size:.72rem;color:var(--text3);}
.progress-track{height:4px;background:var(--surface3);border-radius:2px;overflow:hidden;}
.progress-fill{height:100%;background:var(--green);border-radius:2px;transition:width .5s ease;}
.mp-dates{display:flex;justify-content:space-between;margin-top:8px;}
.mp-date{font-family:'IBM Plex Mono',monospace;font-size:.65rem;color:var(--text3);}
/* SUMMARY CARDS */
.summary-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px;}
.summary-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px 22px;border-top:2px solid var(--border);}
.summary-card.inc{border-top-color:var(--green);}
.summary-card.exp{border-top-color:var(--red);}
.summary-card.net.pos{border-top-color:var(--green);}
.summary-card.net.neg{border-top-color:var(--red);}
.summary-card.spend{border-top-color:var(--yellow);}
.card-label{font-family:'IBM Plex Mono',monospace;font-size:.68rem;color:var(--text3);letter-spacing:.08em;text-transform:uppercase;margin-bottom:8px;}
.card-value{font-size:1.6rem;font-weight:800;letter-spacing:-.04em;margin-bottom:4px;}
.card-value.green{color:var(--green);}
.card-value.red{color:var(--red);}
.card-value.yellow{color:var(--yellow);}
.card-sub{font-family:'IBM Plex Mono',monospace;font-size:.68rem;color:var(--text3);}
/* SPLIT ROW */
.split-row{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px;}
.split-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px 22px;}
.split-title{font-size:.82rem;font-weight:700;letter-spacing:.02em;margin-bottom:14px;color:var(--text2);}
.split-row-item{display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px solid var(--border);}
.split-row-item:last-child{border-bottom:none;}
.split-row-item.total{border-top:1px solid var(--border2);margin-top:4px;padding-top:12px;}
.sri-label{font-size:.82rem;font-weight:600;}
.sri-amt{font-family:'IBM Plex Mono',monospace;font-size:.88rem;font-weight:500;}
.sri-amt.green{color:var(--green);}
.sri-amt.red{color:var(--red);}
/* CHARTS */
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px;}
.chart-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:22px;}
.chart-title{font-size:.82rem;font-weight:700;margin-bottom:16px;color:var(--text2);}
.chart-wrap{height:220px;position:relative;}
/* TABLES */
.table-section{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:20px;}
.table-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
.table-title{font-size:.88rem;font-weight:700;}
.table-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;}
th{font-family:'IBM Plex Mono',monospace;font-size:.65rem;color:var(--text3);letter-spacing:.1em;text-transform:uppercase;padding:10px 16px;text-align:left;border-bottom:1px solid var(--border);}
td{padding:11px 16px;font-size:.82rem;border-bottom:1px solid var(--border);vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tr.empty-row td{color:var(--text3);font-family:'IBM Plex Mono',monospace;font-size:.75rem;text-align:center;padding:28px;}
.mono{font-family:'IBM Plex Mono',monospace;}
.amount-pos{color:var(--green);font-family:'IBM Plex Mono',monospace;font-size:.85rem;font-weight:500;}
.amount-neg{color:var(--red);font-family:'IBM Plex Mono',monospace;font-size:.85rem;font-weight:500;}
.type-badge{display:inline-block;font-family:'IBM Plex Mono',monospace;font-size:.62rem;padding:3px 8px;border-radius:4px;letter-spacing:.04em;}
.badge-income{background:rgba(74,222,128,.1);color:var(--green);}
.badge-expense{background:rgba(248,113,113,.1);color:var(--red);}
.badge-rec-income{background:rgba(96,165,250,.1);color:var(--blue);}
.badge-rec-expense{background:rgba(192,132,252,.1);color:var(--purple);}
.status-badge{font-family:'IBM Plex Mono',monospace;font-size:.62rem;padding:3px 8px;border-radius:4px;display:inline-block;}
.status-done,.status-paid{background:rgba(74,222,128,.1);color:var(--green);}
.status-partial{background:rgba(251,191,36,.1);color:var(--yellow);}
.status-pending{background:rgba(102,102,102,.1);color:var(--text3);}
.status-unpaid{background:rgba(248,113,113,.1);color:var(--red);}
.override-btns{display:flex;gap:4px;}
.override-btn{background:none;border:1px solid var(--border2);color:var(--text3);font-family:'IBM Plex Mono',monospace;font-size:.6rem;padding:3px 7px;border-radius:4px;cursor:pointer;transition:all .15s;}
.override-btn:hover{border-color:var(--text3);color:var(--text);}
.override-btn.active-paid{border-color:var(--green);color:var(--green);}
.override-btn.active-unpaid{border-color:var(--red);color:var(--red);}
.delete-btn{background:none;border:none;color:var(--text3);cursor:pointer;font-size:.8rem;padding:4px 8px;border-radius:4px;transition:color .15s;}
.delete-btn:hover{color:var(--red);}
/* ADD ENTRY */
.add-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.form-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:24px;}
.form-card-title{font-size:.95rem;font-weight:700;margin-bottom:4px;}
.form-card-sub{font-family:'IBM Plex Mono',monospace;font-size:.68rem;color:var(--text3);margin-bottom:20px;}
.form-group{margin-bottom:14px;}
.form-group label{display:block;font-family:'IBM Plex Mono',monospace;font-size:.65rem;color:var(--text3);letter-spacing:.08em;text-transform:uppercase;margin-bottom:6px;}
.form-group input,.form-group select{width:100%;background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);padding:10px 12px;color:var(--text);font-family:'IBM Plex Mono',monospace;font-size:.85rem;outline:none;transition:border-color .2s;appearance:none;}
.form-group input:focus,.form-group select:focus{border-color:var(--text3);}
.form-group input::placeholder{color:var(--text3);}
.input-prefix{position:relative;display:flex;align-items:center;}
.input-prefix span{position:absolute;left:12px;color:var(--text3);font-family:'IBM Plex Mono',monospace;font-size:.82rem;}
.input-prefix input{padding-left:26px;}
.submit-btn{width:100%;background:var(--white);color:var(--bg);border:none;border-radius:var(--radius-sm);padding:11px;font-family:'Syne',sans-serif;font-size:.88rem;font-weight:700;cursor:pointer;margin-top:6px;transition:opacity .2s;}
.submit-btn:hover{opacity:.85;}
.success-flash{font-family:'IBM Plex Mono',monospace;font-size:.72rem;color:var(--green);margin-top:10px;opacity:0;transition:opacity .3s;height:18px;}
.success-flash.show{opacity:1;}
.day-picker{display:flex;gap:6px;flex-wrap:wrap;}
.day-btn{background:var(--surface2);border:1px solid var(--border2);color:var(--text2);font-family:'IBM Plex Mono',monospace;font-size:.7rem;padding:5px 9px;border-radius:4px;cursor:pointer;transition:all .15s;}
.day-btn.active{background:rgba(74,222,128,.1);border-color:var(--green);color:var(--green);}
.monthly-preview{background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);padding:12px;margin-bottom:14px;}
.preview-label{font-family:'IBM Plex Mono',monospace;font-size:.6rem;color:var(--text3);letter-spacing:.1em;text-transform:uppercase;margin-bottom:4px;}
.monthly-preview span{font-size:1.1rem;font-weight:800;color:var(--green);}
/* REPORT */
.report-controls{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;}
.filter-btn{background:var(--surface);border:1px solid var(--border);color:var(--text2);font-family:'Syne',sans-serif;font-size:.75rem;font-weight:600;padding:7px 14px;border-radius:var(--radius-sm);cursor:pointer;transition:all .2s;}
.filter-btn:hover{background:var(--surface3);color:var(--white);}
.filter-btn.active{background:var(--surface3);border-color:var(--border2);color:var(--white);}
/* GOALS */
.goals-grid{display:flex;flex-direction:column;gap:12px;margin-bottom:20px;}
.goal-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px 24px;display:grid;grid-template-columns:1fr auto;gap:16px;align-items:center;position:relative;overflow:hidden;}
.goal-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--blue);}
.goal-card.complete::before{background:var(--green);}
.goal-card.urgent::before{background:var(--yellow);}
.goal-card.overdue::before{background:var(--red);}
.goal-card-left{display:flex;flex-direction:column;gap:10px;}
.goal-title{font-size:1rem;font-weight:800;letter-spacing:-.02em;}
.goal-meta{display:flex;gap:20px;flex-wrap:wrap;align-items:center;}
.goal-meta-item{font-family:'IBM Plex Mono',monospace;font-size:.68rem;color:var(--text2);}
.goal-meta-item span{color:var(--text);}
.goal-meta-item.warn span{color:var(--yellow);}
.goal-meta-item.good span{color:var(--green);}
.goal-meta-item.over span{color:var(--red);}
.goal-progress-wrap{margin-top:4px;}
.goal-progress-track{height:4px;background:var(--surface3);border-radius:2px;overflow:hidden;margin-bottom:5px;}
.goal-progress-fill{height:100%;border-radius:2px;transition:width .4s ease;}
.goal-progress-label{font-family:'IBM Plex Mono',monospace;font-size:.63rem;color:var(--text3);}
.goal-card-right{display:flex;flex-direction:column;align-items:flex-end;gap:10px;}
.goal-amount-big{font-size:1.5rem;font-weight:800;letter-spacing:-.03em;color:var(--blue);}
.goal-amount-big.complete{color:var(--green);}
.goal-checkin-btn{background:var(--surface2);border:1px solid var(--border2);color:var(--text2);font-family:'Syne',sans-serif;font-size:.75rem;font-weight:600;padding:8px 14px;border-radius:var(--radius-sm);cursor:pointer;transition:all .2s;white-space:nowrap;}
.goal-checkin-btn:hover{border-color:var(--green);color:var(--green);}
.goal-checkin-btn.checked{background:rgba(74,222,128,.1);border-color:var(--green);color:var(--green);}
.goal-delete-btn{background:none;border:none;color:var(--text3);cursor:pointer;font-size:.75rem;font-family:'IBM Plex Mono',monospace;padding:4px 6px;transition:color .15s;}
.goal-delete-btn:hover{color:var(--red);}
.goal-badge{font-family:'IBM Plex Mono',monospace;font-size:.6rem;padding:3px 8px;border-radius:4px;letter-spacing:.04em;display:inline-block;}
.goal-badge-active{background:rgba(96,165,250,.1);color:var(--blue);}
.goal-badge-complete{background:rgba(74,222,128,.1);color:var(--green);}
.goal-badge-overdue{background:rgba(248,113,113,.1);color:var(--red);}
.goal-badge-urgent{background:rgba(251,191,36,.1);color:var(--yellow);}
.goal-empty{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:40px;text-align:center;color:var(--text3);font-family:'IBM Plex Mono',monospace;font-size:.78rem;}
/* INVESTMENTS */
.inv-refresh-btn{background:none;border:1px solid var(--border2);color:var(--text2);font-family:'Syne',sans-serif;font-size:.75rem;font-weight:600;padding:8px 14px;border-radius:var(--radius-sm);cursor:pointer;transition:all .2s;white-space:nowrap;}
.inv-refresh-btn:hover{border-color:var(--text3);color:var(--white);}
.inv-summary-bar{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px 24px;margin-bottom:16px;display:flex;align-items:center;flex-wrap:wrap;gap:0;}
.inv-sum-block{display:flex;flex-direction:column;gap:4px;padding:0 24px;flex:1;min-width:110px;}
.inv-sum-block:first-child{padding-left:0;}
.inv-sum-sep{width:1px;height:36px;background:var(--border2);margin:0 4px;}
.inv-sum-label{font-family:'IBM Plex Mono',monospace;font-size:.63rem;color:var(--text3);letter-spacing:.1em;text-transform:uppercase;}
.inv-sum-val{font-size:1.15rem;font-weight:800;letter-spacing:-.03em;}
.inv-cards-grid{display:flex;flex-direction:column;gap:14px;margin-bottom:16px;}
.inv-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:22px 26px;position:relative;overflow:hidden;transition:border-color .2s;display:grid;grid-template-columns:220px 1fr 200px;gap:0;align-items:center;}
.inv-card:hover{border-color:var(--border3);}
.inv-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--border2);}
.inv-card.has-holding::before{background:var(--green);box-shadow:0 0 8px rgba(74,222,128,.4);}
.inv-card-left{display:flex;flex-direction:column;gap:4px;padding-right:24px;border-right:1px solid var(--border);}
.inv-card-rank{font-family:'IBM Plex Mono',monospace;font-size:.6rem;color:var(--text3);margin-bottom:4px;letter-spacing:.06em;}
.inv-card-icon-badge{display:inline-block;font-family:'IBM Plex Mono',monospace;font-size:.7rem;font-weight:500;color:var(--text2);background:var(--surface2);border:1px solid var(--border2);padding:3px 8px;border-radius:4px;margin-bottom:8px;letter-spacing:.04em;}
.inv-card-name{font-size:1rem;font-weight:800;letter-spacing:-.02em;margin-bottom:2px;}
.inv-card-ticker{font-family:'IBM Plex Mono',monospace;font-size:.68rem;color:var(--text3);}
.inv-card-price{font-family:'IBM Plex Mono',monospace;font-size:1.1rem;font-weight:500;color:var(--white);margin-top:12px;}
.inv-card-change{font-family:'IBM Plex Mono',monospace;font-size:.72rem;margin-top:3px;}
.inv-card-change.up{color:var(--green);}
.inv-card-change.down{color:var(--red);}
.inv-card-chart{padding:0 24px;height:120px;position:relative;}
.inv-card-chart canvas{width:100%!important;height:120px!important;}
.inv-card-right{padding-left:24px;border-left:1px solid var(--border);}
.inv-card-desc{font-family:'IBM Plex Mono',monospace;font-size:.68rem;color:var(--text3);line-height:1.7;}
.inv-holding-block{font-family:'IBM Plex Mono',monospace;font-size:.72rem;color:var(--text2);line-height:2;}
.inv-holding-val{font-size:.95rem;font-weight:800;font-family:'Syne',sans-serif;color:var(--white);}
.inv-gain-pos{color:var(--green);}
.inv-gain-neg{color:var(--red);}
@media(max-width:960px){
  .summary-grid{grid-template-columns:1fr 1fr;}
  .charts-grid,.split-row,.add-grid{grid-template-columns:1fr;}
  main{padding:18px 16px;}
  header{padding:14px 18px;}
  .balance-input-wrap{margin-left:0;width:100%;}
  .inv-card{grid-template-columns:1fr;}
  .inv-card-left{border-right:none;border-bottom:1px solid var(--border);padding-right:0;padding-bottom:16px;margin-bottom:16px;}
  .inv-card-right{border-left:none;border-top:1px solid var(--border);padding-left:0;padding-top:16px;margin-top:8px;}
  .inv-card-chart{padding:0;height:100px;}
}
</style>
</head>
<body>
<header>
  <div class="logo">Budget<span>Wise</span></div>
  <nav>
    <button class="active" onclick="showPage('dashboard',this)">Dashboard</button>
    <button onclick="showPage('add',this)">Add Entry</button>
    <button onclick="showPage('goals',this)">Goals</button>
    <button onclick="showPage('report',this)">Report</button>
  </nav>
</header>
<main>

<!-- ═══════════════════════════════ DASHBOARD ═══════════════════════════════ -->
<div class="page active" id="page-dashboard">
  <div class="section-title">Overview</div>
  <div class="section-sub" id="dash-date"></div>

  <div class="balance-bar">
    <div class="balance-main">
      <div class="balance-label">Estimated Bank Balance</div>
      <div class="balance-amount green" id="bal-amount">$0.00</div>
      <div class="balance-note" id="bal-note">set your actual balance below to start tracking</div>
    </div>
    <div class="balance-sep"></div>
    <div class="balance-meta">
      <div class="balance-meta-row">Safe to spend: <span id="bal-spending-left" style="color:var(--yellow)">$0.00</span></div>
      <div class="balance-meta-row">Income still coming: <span id="bal-inc-left" style="color:var(--green)">$0.00</span></div>
      <div class="balance-meta-row">Expenses still due: <span id="bal-exp-left" style="color:var(--red)">$0.00</span></div>
    </div>
    <div class="balance-sep"></div>
    <div class="balance-meta">
      <div class="balance-meta-row">Received so far: <span id="bal-inc-done" style="color:var(--green)">$0.00</span></div>
      <div class="balance-meta-row">Paid so far: <span id="bal-exp-done" style="color:var(--red)">$0.00</span></div>
    </div>
    <div class="balance-input-wrap">
      <div class="balance-input-pre">
        <input class="balance-input" type="number" id="bank-input" placeholder="Actual balance" step="0.01"/>
      </div>
      <button class="set-balance-btn" onclick="setBalance()">Set Balance</button>
    </div>
  </div>

  <div class="month-progress-card">
    <div class="mp-header">
      <div class="mp-title" id="mp-month-label">Month Progress</div>
      <div class="mp-pct" id="mp-pct">0%</div>
    </div>
    <div class="progress-track"><div class="progress-fill" id="mp-fill" style="width:0%"></div></div>
    <div class="mp-dates"><span class="mp-date" id="mp-start"></span><span class="mp-date" id="mp-today-label"></span><span class="mp-date" id="mp-end"></span></div>
  </div>

  <div class="summary-grid">
    <div class="summary-card inc"><div class="card-label">Monthly Income</div><div class="card-value green" id="s-income">$0.00</div><div class="card-sub" id="s-income-sub">estimated this month</div></div>
    <div class="summary-card exp"><div class="card-label">Monthly Expenses</div><div class="card-value red" id="s-expense">$0.00</div><div class="card-sub" id="s-expense-sub">estimated this month</div></div>
    <div class="summary-card net" id="s-net-card"><div class="card-label">Net This Month</div><div class="card-value" id="s-net">$0.00</div><div class="card-sub">income minus expenses</div></div>
    <div class="summary-card spend"><div class="card-label">Spending Money Left</div><div class="card-value yellow" id="s-spending">$0.00</div><div class="card-sub" id="s-spending-sub">after all remaining expenses</div></div>
  </div>

  <div class="split-row">
    <div class="split-card"><div class="split-title">Income This Month</div><div id="inc-split-rows"></div></div>
    <div class="split-card"><div class="split-title">Expenses This Month</div><div id="exp-split-rows"></div></div>
  </div>

  <div class="charts-grid">
    <div class="chart-card"><div class="chart-title">Income vs Expenses</div><div class="chart-wrap"><canvas id="barChart"></canvas></div></div>
    <div class="chart-card"><div class="chart-title">Expense Breakdown</div><div class="chart-wrap"><canvas id="donutChart"></canvas></div></div>
  </div>

  <div class="table-section">
    <div class="table-header"><div class="table-title">Recurring — Status This Month</div></div>
    <div class="table-wrap"><table>
      <thead><tr><th>Description</th><th>Type</th><th>Schedule</th><th>Est. Monthly</th><th>Occurrences</th><th>Status</th><th></th></tr></thead>
      <tbody id="recurring-tbody"></tbody>
    </table></div>
  </div>

  <div class="table-section">
    <div class="table-header"><div class="table-title">One-Time Entries This Month</div></div>
    <div class="table-wrap"><table>
      <thead><tr><th>Date</th><th>Description</th><th>Type</th><th>Amount</th><th></th></tr></thead>
      <tbody id="onetime-tbody"></tbody>
    </table></div>
  </div>

  <!-- GOALS SUMMARY ON DASHBOARD -->
  <div id="dash-goals-section" style="display:none;margin-bottom:8px">
    <div style="margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;">
      <div>
        <div class="section-title" style="font-size:1.2rem">Savings Goals</div>
        <div class="section-sub" style="margin-bottom:0">// set aside money towards your goals — not counted as expenses</div>
      </div>
      <button class="inv-refresh-btn" onclick="showPage('goals',document.querySelector('nav button:nth-child(3)'))">View All Goals →</button>
    </div>
    <div class="goals-grid" id="dash-goals-grid"></div>
  </div>

  <!-- INVESTMENTS -->
  <div style="margin-top:8px;margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
    <div>
      <div class="section-title" style="font-size:1.2rem">Investments</div>
      <div class="section-sub" style="margin-bottom:0" id="inv-last-updated">// loading live prices…</div>
    </div>
    <button class="inv-refresh-btn" onclick="loadInvestmentPrices()">↻ Refresh Prices</button>
  </div>
  <div class="inv-summary-bar" id="inv-summary-bar" style="display:none">
    <div class="inv-sum-block"><div class="inv-sum-label">Total Invested</div><div class="inv-sum-val" id="inv-total-invested">$0</div></div>
    <div class="inv-sum-sep"></div>
    <div class="inv-sum-block"><div class="inv-sum-label">Current Value</div><div class="inv-sum-val" id="inv-current-val">$0</div></div>
    <div class="inv-sum-sep"></div>
    <div class="inv-sum-block"><div class="inv-sum-label">Gain / Loss</div><div class="inv-sum-val" id="inv-gain-loss">$0</div></div>
    <div class="inv-sum-sep"></div>
    <div class="inv-sum-block"><div class="inv-sum-label">Return</div><div class="inv-sum-val" id="inv-return-pct">0%</div></div>
  </div>
  <div class="inv-cards-grid" id="inv-cards-grid"></div>
  <div class="table-section" id="inv-table-section" style="display:none">
    <div class="table-header"><div class="table-title">My Holdings</div></div>
    <div class="table-wrap"><table>
      <thead><tr><th>Asset</th><th>Date</th><th>Invested</th><th>Buy Price</th><th>Units</th><th>Current Price</th><th>Value Now</th><th>Gain/Loss</th><th>Return</th><th></th></tr></thead>
      <tbody id="inv-holdings-tbody"></tbody>
    </table></div>
  </div>
</div>

<!-- ═══════════════════════════════ ADD ENTRY ═══════════════════════════════ -->
<div class="page" id="page-add">
  <div class="section-title">Add Entry</div>
  <div class="section-sub">// record a new income or expense</div>
  <div class="add-grid">
    <div class="form-card">
      <div class="form-card-title">Income</div>
      <div class="form-card-sub">// one-time income entry</div>
      <div class="form-group"><label>Amount</label><div class="input-prefix"><span>$</span><input type="number" id="i-amount" placeholder="0.00" min="0" step="0.01"/></div></div>
      <div class="form-group"><label>Description</label><input type="text" id="i-desc" placeholder="e.g. Freelance payment"/></div>
      <div class="form-group"><label>Date</label><input type="date" id="i-date"/></div>
      <button class="submit-btn" onclick="addOneTime('income')">Add Income</button>
      <div class="success-flash" id="flash-income">Entry added ✓</div>
    </div>
    <div class="form-card">
      <div class="form-card-title">Expense</div>
      <div class="form-card-sub">// one-time expense entry</div>
      <div class="form-group"><label>Amount</label><div class="input-prefix"><span>$</span><input type="number" id="e-amount" placeholder="0.00" min="0" step="0.01"/></div></div>
      <div class="form-group"><label>Description</label><input type="text" id="e-desc" placeholder="e.g. Groceries"/></div>
      <div class="form-group"><label>Date</label><input type="date" id="e-date"/></div>
      <button class="submit-btn" onclick="addOneTime('expense')">Add Expense</button>
      <div class="success-flash" id="flash-expense">Entry added ✓</div>
    </div>
    <div class="form-card">
      <div class="form-card-title">Recurring Income</div>
      <div class="form-card-sub">// auto-calculates estimated monthly total</div>
      <div class="form-group"><label>Amount per occurrence</label><div class="input-prefix"><span>$</span><input type="number" id="ri-amount" placeholder="0.00" min="0" step="0.01" oninput="updatePreview('ri')"/></div></div>
      <div class="form-group"><label>Description</label><input type="text" id="ri-desc" placeholder="e.g. Salary, Tips"/></div>
      <div class="form-group"><label>Frequency</label>
        <select id="ri-freq" onchange="updateFreqUI('ri');updatePreview('ri')">
          <option value="monthly">Monthly</option>
          <option value="weekly">Weekly (pick days)</option>
          <option value="biweekly">Bi-weekly</option>
          <option value="daily">Daily</option>
        </select>
      </div>
      <div class="form-group" id="ri-days-group" style="display:none"><label>Days of week</label>
        <div class="day-picker" id="ri-days">
          <button type="button" class="day-btn" onclick="toggleDay('ri',0)">Sun</button>
          <button type="button" class="day-btn" onclick="toggleDay('ri',1)">Mon</button>
          <button type="button" class="day-btn" onclick="toggleDay('ri',2)">Tue</button>
          <button type="button" class="day-btn" onclick="toggleDay('ri',3)">Wed</button>
          <button type="button" class="day-btn" onclick="toggleDay('ri',4)">Thu</button>
          <button type="button" class="day-btn" onclick="toggleDay('ri',5)">Fri</button>
          <button type="button" class="day-btn" onclick="toggleDay('ri',6)">Sat</button>
        </div>
      </div>
      <div class="form-group"><label>Start Date</label><input type="date" id="ri-date"/></div>
      <div class="monthly-preview" id="ri-preview" style="display:none"><div class="preview-label">Est. Monthly Total</div><span id="ri-preview-val"></span></div>
      <button class="submit-btn" onclick="addRecurring('income')">Add Recurring Income</button>
      <div class="success-flash" id="flash-recurring-income">Entry added ✓</div>
    </div>
    <div class="form-card">
      <div class="form-card-title">Recurring Expense</div>
      <div class="form-card-sub">// auto-calculates estimated monthly total</div>
      <div class="form-group"><label>Amount per occurrence</label><div class="input-prefix"><span>$</span><input type="number" id="re-amount" placeholder="0.00" min="0" step="0.01" oninput="updatePreview('re')"/></div></div>
      <div class="form-group"><label>Description</label><input type="text" id="re-desc" placeholder="e.g. Rent, Netflix"/></div>
      <div class="form-group"><label>Frequency</label>
        <select id="re-freq" onchange="updateFreqUI('re');updatePreview('re')">
          <option value="monthly">Monthly</option>
          <option value="weekly">Weekly (pick days)</option>
          <option value="biweekly">Bi-weekly</option>
          <option value="daily">Daily</option>
        </select>
      </div>
      <div class="form-group" id="re-days-group" style="display:none"><label>Days of week</label>
        <div class="day-picker" id="re-days">
          <button type="button" class="day-btn" onclick="toggleDay('re',0)">Sun</button>
          <button type="button" class="day-btn" onclick="toggleDay('re',1)">Mon</button>
          <button type="button" class="day-btn" onclick="toggleDay('re',2)">Tue</button>
          <button type="button" class="day-btn" onclick="toggleDay('re',3)">Wed</button>
          <button type="button" class="day-btn" onclick="toggleDay('re',4)">Thu</button>
          <button type="button" class="day-btn" onclick="toggleDay('re',5)">Fri</button>
          <button type="button" class="day-btn" onclick="toggleDay('re',6)">Sat</button>
        </div>
      </div>
      <div class="form-group"><label>Start Date</label><input type="date" id="re-date"/></div>
      <div class="monthly-preview" id="re-preview" style="display:none"><div class="preview-label">Est. Monthly Total</div><span id="re-preview-val"></span></div>
      <button class="submit-btn" onclick="addRecurring('expense')">Add Recurring Expense</button>
      <div class="success-flash" id="flash-recurring-expense">Entry added ✓</div>
    </div>
    <!-- INVESTMENT — full width -->
    <div class="form-card" style="grid-column:1/-1">
      <div class="form-card-title">Investment</div>
      <div class="form-card-sub">// track money you've put into BTC, ETFs, or other assets — visible on dashboard</div>
      <div style="display:grid;grid-template-columns:1.5fr 1fr 1fr 1.2fr auto;gap:14px;align-items:flex-end;flex-wrap:wrap;">
        <div class="form-group" style="margin-bottom:0"><label>Asset</label>
          <select id="inv-asset">
            <option value="BTC-USD">Bitcoin (BTC) — High risk, high reward</option>
            <option value="VOO">VOO — Vanguard S&P 500</option>
            <option value="QQQ">QQQ — Nasdaq 100 ETF</option>
            <option value="GLD">GLD — SPDR Gold ETF</option>
            <option value="VNQ">VNQ — Vanguard Real Estate</option>
          </select>
        </div>
        <div class="form-group" style="margin-bottom:0"><label>Amount invested ($)</label><div class="input-prefix"><span>$</span><input type="number" id="inv-amount" placeholder="0.00" min="0" step="0.01"/></div></div>
        <div class="form-group" style="margin-bottom:0"><label>Date purchased</label><input type="date" id="inv-date"/></div>
        <div class="form-group" style="margin-bottom:0"><label>Price per unit at purchase</label><div class="input-prefix"><span>$</span><input type="number" id="inv-price" placeholder="e.g. 95000 for BTC" step="0.01" min="0"/></div></div>
        <div class="form-group" style="margin-bottom:0"><label>&nbsp;</label><button class="submit-btn" style="white-space:nowrap;margin-top:0" onclick="addInvestment()">Add Investment</button></div>
      </div>
      <div class="success-flash" id="flash-investment">Investment added ✓</div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════ GOALS ═══════════════════════════════ -->
<div class="page" id="page-goals">
  <div class="section-title">Savings Goals</div>
  <div class="section-sub">// set money aside for specific targets — not counted as expenses</div>

  <!-- ADD GOAL FORM -->
  <div class="form-card" style="margin-bottom:20px">
    <div class="form-card-title">New Goal</div>
    <div class="form-card-sub">// set a target, a deadline, and how often you want to set money aside</div>
    <div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr auto;gap:14px;align-items:flex-end;flex-wrap:wrap;">
      <div class="form-group" style="margin-bottom:0">
        <label>Goal Name</label>
        <input type="text" id="goal-name" placeholder="e.g. Wedding road trip"/>
      </div>
      <div class="form-group" style="margin-bottom:0">
        <label>Target Amount ($)</label>
        <div class="input-prefix"><span>$</span><input type="number" id="goal-target" placeholder="2000.00" min="0" step="0.01" oninput="updateGoalPreview()"/></div>
      </div>
      <div class="form-group" style="margin-bottom:0">
        <label>Goal Date</label>
        <input type="date" id="goal-date" onchange="updateGoalPreview()"/>
      </div>
      <div class="form-group" style="margin-bottom:0">
        <label>Save every</label>
        <select id="goal-freq" onchange="updateGoalPreview()">
          <option value="monthly">Month</option>
          <option value="weekly">Week</option>
          <option value="daily">Day</option>
        </select>
      </div>
      <div class="form-group" style="margin-bottom:0">
        <label>You need to save</label>
        <div style="background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius-sm);padding:10px 12px;font-family:'IBM Plex Mono',monospace;font-size:.85rem;color:var(--green);font-weight:600;" id="goal-preview-val">--</div>
      </div>
      <div class="form-group" style="margin-bottom:0">
        <label>&nbsp;</label>
        <button class="submit-btn" style="white-space:nowrap;margin-top:0" onclick="addGoal()">Add Goal</button>
      </div>
    </div>
    <div class="success-flash" id="flash-goal">Goal added ✓</div>
  </div>

  <!-- GOALS LIST -->
  <div class="goals-grid" id="goals-grid"></div>
  <div class="goal-empty" id="goals-empty" style="display:none">No goals yet. Add one above to start saving towards something.</div>
</div>

<!-- ═══════════════════════════════ REPORT ═══════════════════════════════ -->
<div class="page" id="page-report">
  <div class="section-title">Full Report</div>
  <div class="section-sub">// all transactions</div>
  <div class="report-controls">
    <button class="filter-btn active" onclick="setFilter('all',this)">All</button>
    <button class="filter-btn" onclick="setFilter('income',this)">Income</button>
    <button class="filter-btn" onclick="setFilter('expense',this)">Expenses</button>
    <button class="filter-btn" onclick="setFilter('recurring-income',this)">Recurring Income</button>
    <button class="filter-btn" onclick="setFilter('recurring-expense',this)">Recurring Expenses</button>
  </div>
  <div class="table-wrap"><table>
    <thead><tr><th>Date</th><th>Description</th><th>Type</th><th>Schedule</th><th>Amount</th><th>Est. Monthly</th><th></th></tr></thead>
    <tbody id="report-tbody"></tbody>
  </table></div>
</div>

</main>
<script>
// ══════════════════════════════════════════════════════
// STORAGE
// ══════════════════════════════════════════════════════
const load     = () => JSON.parse(localStorage.getItem('bw_entries')     || '[]');
const save     = d  => localStorage.setItem('bw_entries',     JSON.stringify(d));
const loadMeta = () => JSON.parse(localStorage.getItem('bw_meta')        || '{}');
const saveMeta = m  => localStorage.setItem('bw_meta',        JSON.stringify(m));
const loadInv  = () => JSON.parse(localStorage.getItem('bw_investments') || '[]');
const saveInv  = d  => localStorage.setItem('bw_investments', JSON.stringify(d));

// ══════════════════════════════════════════════════════
// UTILS
// ══════════════════════════════════════════════════════
const fmt     = n => '$' + Math.abs(parseFloat(n)).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
const today   = () => new Date().toISOString().split('T')[0];
const fmtDate = d => { if (!d) return ''; const [y,m,day] = d.split('-'); return `${m}/${day}/${y}`; };
const DAY_NAMES = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

function getMonthBounds() {
  const now   = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), 1);
  const end   = new Date(now.getFullYear(), now.getMonth()+1, 0, 23, 59, 59);
  return { now, start, end, day: now.getDate(), totalDays: end.getDate() };
}

function calcMonthly(amount, freq, days) {
  if (freq === 'monthly')  return amount;
  if (freq === 'biweekly') return amount * 2;
  if (freq === 'daily')    return amount * 30.44;
  if (freq === 'weekly')   return amount * (days||[]).length * (365.25/12/7);
  return amount;
}

function scheduleLabel(freq, days) {
  if (freq === 'monthly')  return 'Monthly';
  if (freq === 'biweekly') return 'Bi-weekly';
  if (freq === 'daily')    return 'Daily';
  if (freq === 'weekly')   return 'Weekly · ' + (days||[]).map(d => DAY_NAMES[d]).join(', ');
  return freq;
}

function flash(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2400);
}

// ══════════════════════════════════════════════════════
// FREQUENCY UI
// ══════════════════════════════════════════════════════
function updateFreqUI(p) {
  document.getElementById(p+'-days-group').style.display =
    document.getElementById(p+'-freq').value === 'weekly' ? 'block' : 'none';
}
function toggleDay(p, i) {
  document.querySelector(`#${p}-days .day-btn:nth-child(${i+1})`).classList.toggle('active');
  updatePreview(p);
}
function getSelectedDays(p) {
  return [...document.querySelectorAll(`#${p}-days .day-btn.active`)].map(b => DAY_NAMES.indexOf(b.textContent));
}
function updatePreview(p) {
  const amt  = parseFloat(document.getElementById(p+'-amount').value) || 0;
  const freq = document.getElementById(p+'-freq').value;
  const mo   = calcMonthly(amt, freq, getSelectedDays(p));
  document.getElementById(p+'-preview').style.display = amt > 0 ? 'block' : 'none';
  document.getElementById(p+'-preview-val').textContent = fmt(mo) + '/mo';
}

// ══════════════════════════════════════════════════════
// ADD ENTRIES
// ══════════════════════════════════════════════════════
function addOneTime(type) {
  const p = type === 'income' ? 'i' : 'e';
  const amount = parseFloat(document.getElementById(p+'-amount').value);
  const desc   = document.getElementById(p+'-desc').value.trim();
  const date   = document.getElementById(p+'-date').value || today();
  if (!amount || amount <= 0) { alert('Enter a valid amount.'); return; }
  if (!desc) { alert('Enter a description.'); return; }
  const entries = load();
  entries.push({ id: Date.now(), type, amount, description: desc, date, freq: null, days: null, monthlyAmount: amount });
  save(entries);
  document.getElementById(p+'-amount').value = '';
  document.getElementById(p+'-desc').value   = '';
  flash('flash-' + type);
  renderDashboard();
}

function addRecurring(type) {
  const p      = type === 'income' ? 'ri' : 're';
  const amount = parseFloat(document.getElementById(p+'-amount').value);
  const desc   = document.getElementById(p+'-desc').value.trim();
  const freq   = document.getElementById(p+'-freq').value;
  const days   = freq === 'weekly' ? getSelectedDays(p) : null;
  const date   = document.getElementById(p+'-date').value || today();
  if (!amount || amount <= 0) { alert('Enter a valid amount.'); return; }
  if (!desc) { alert('Enter a description.'); return; }
  if (freq === 'weekly' && (!days || days.length === 0)) { alert('Pick at least one day.'); return; }
  const entries = load();
  entries.push({ id: Date.now(), type: 'recurring-'+type, amount, description: desc, date, freq, days,
    monthlyAmount: calcMonthly(amount, freq, days) });
  save(entries);
  document.getElementById(p+'-amount').value = '';
  document.getElementById(p+'-desc').value   = '';
  document.getElementById(p+'-preview').style.display = 'none';
  flash('flash-recurring-' + type);
  renderDashboard();
}

function deleteEntry(id) {
  if (!confirm('Delete this entry?')) return;
  save(load().filter(e => e.id !== id));
  renderDashboard();
  renderReport();
}

// ══════════════════════════════════════════════════════
// OCCURRENCES (for recurring status)
// ══════════════════════════════════════════════════════
function occurrencesSoFar(entry) {
  const { now, start, day } = getMonthBounds();
  const freq = entry.freq;
  const sd   = entry.date ? new Date(entry.date + 'T00:00:00') : start;
  if (freq === 'monthly')  return sd.getDate() <= day ? 1 : 0;
  if (freq === 'biweekly') {
    let n = 0, c = new Date(sd);
    while (c < start) c.setDate(c.getDate() + 14);
    while (c <= now)  { if (c >= start) n++; c.setDate(c.getDate() + 14); }
    return n;
  }
  if (freq === 'daily') return day;
  if (freq === 'weekly') {
    const days = entry.days || []; let n = 0, c = new Date(start);
    while (c <= now) { if (days.includes(c.getDay())) n++; c.setDate(c.getDate() + 1); }
    return n;
  }
  return 0;
}

function occurrencesTotal(entry) {
  const { start, end } = getMonthBounds();
  const freq = entry.freq;
  const sd   = entry.date ? new Date(entry.date + 'T00:00:00') : start;
  if (freq === 'monthly')  return 1;
  if (freq === 'biweekly') {
    let n = 0, c = new Date(sd);
    while (c < start) c.setDate(c.getDate() + 14);
    while (c <= end)  { n++; c.setDate(c.getDate() + 14); }
    return n;
  }
  if (freq === 'daily') return end.getDate();
  if (freq === 'weekly') {
    const days = entry.days || []; let n = 0, c = new Date(start);
    while (c <= end) { if (days.includes(c.getDay())) n++; c.setDate(c.getDate() + 1); }
    return n;
  }
  return 1;
}

// ══════════════════════════════════════════════════════
// MANUAL STATUS OVERRIDE
// ══════════════════════════════════════════════════════
function statusKey(id) {
  const n = new Date();
  return `status_${id}_${n.getFullYear()}_${n.getMonth()+1}`;
}
function getManualStatus(id) { return loadMeta()[statusKey(id)]; }
function setManualStatus(id, val) {
  const m = loadMeta();
  if (val === null) delete m[statusKey(id)]; else m[statusKey(id)] = val;
  saveMeta(m);
  renderDashboard();
}
function autoStatus(e) {
  const s = occurrencesSoFar(e), t = occurrencesTotal(e);
  if (s === 0) return 'pending';
  if (s >= t)  return 'done';
  return 'partial';
}
function effectiveStatus(e) { return getManualStatus(e.id) || autoStatus(e); }

// ══════════════════════════════════════════════════════
// BANK BALANCE — SET SNAPSHOT + PROJECT FORWARD
// The key insight: we store (value, timestamp). On every
// render we replay all cash flows since that timestamp
// so the balance auto-updates as days pass.
// ══════════════════════════════════════════════════════
function setBalance() {
  const val = parseFloat(document.getElementById('bank-input').value);
  if (isNaN(val)) { alert('Enter a valid number.'); return; }
  const m = loadMeta();
  m.bankBalance = val;
  m.bankSet     = new Date().toISOString(); // timestamp of when balance was set
  saveMeta(m);
  document.getElementById('bank-input').value = '';
  renderDashboard();
}

// Count occurrences of a recurring entry strictly after `from` and on/before `to`
function occsBetween(entry, from, to) {
  const freq = entry.freq;
  const sd   = new Date(entry.date + 'T00:00:00');
  let n = 0;
  if (freq === 'monthly') {
    // hits on sd.getDate() each month
    let c = new Date(from.getFullYear(), from.getMonth(), sd.getDate());
    if (c <= from) c = new Date(c.getFullYear(), c.getMonth() + 1, sd.getDate());
    while (c <= to) { n++; c = new Date(c.getFullYear(), c.getMonth() + 1, sd.getDate()); }
  } else if (freq === 'biweekly') {
    let c = new Date(sd);
    while (c <= from) c.setDate(c.getDate() + 14);
    while (c <= to)   { n++; c.setDate(c.getDate() + 14); }
  } else if (freq === 'daily') {
    // days strictly after `from` up to `to`
    const msDay   = 86400000;
    const fromDay = new Date(from.getFullYear(), from.getMonth(), from.getDate());
    const toDay   = new Date(to.getFullYear(),   to.getMonth(),   to.getDate());
    n = Math.max(0, Math.round((toDay - fromDay) / msDay));
  } else if (freq === 'weekly') {
    const days = entry.days || [];
    let c = new Date(from); c.setDate(c.getDate() + 1); c.setHours(0,0,0,0);
    while (c <= to) { if (days.includes(c.getDay())) n++; c.setDate(c.getDate() + 1); }
  }
  return n;
}

// Project a saved balance snapshot forward to `now` by replaying cash flows
function projectBalance(snapVal, snapTime, now, entries) {
  let delta = 0;
  const snapMs     = snapTime.getTime();
  const nowDateStr = now.toISOString().split('T')[0];
  entries.forEach(e => {
    if (e.type === 'recurring-income') {
      delta += occsBetween(e, snapTime, now) * e.amount;
    } else if (e.type === 'recurring-expense') {
      delta -= occsBetween(e, snapTime, now) * e.amount;
    } else if (e.type === 'income') {
      // Count if: created AFTER the snapshot AND dated on or before today
      if (e.id > snapMs && e.date <= nowDateStr) delta += e.amount;
    } else if (e.type === 'expense') {
      // Count if: created AFTER the snapshot AND dated on or before today
      if (e.id > snapMs && e.date <= nowDateStr) delta -= e.amount;
    }
  });
  // Goal checkins made after snapshot also reduce the balance
  delta -= goalCheckInsAfterSnap(snapMs);
  return snapVal + delta;
}

// ══════════════════════════════════════════════════════
// NAV
// ══════════════════════════════════════════════════════
function showPage(id, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  btn.classList.add('active');
  if (id === 'dashboard') renderDashboard();
  if (id === 'goals')     renderGoals();
  if (id === 'report')    renderReport();
}

// ══════════════════════════════════════════════════════
// DASHBOARD
// ══════════════════════════════════════════════════════
function renderDashboard() {
  const entries = load();
  const meta    = loadMeta();
  const { now, start, end, day, totalDays } = getMonthBounds();
  const monthPct = Math.round((day / totalDays) * 100);

  // Date + progress
  document.getElementById('dash-date').textContent =
    '// ' + now.toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
  const mn = now.toLocaleDateString('en-US', { month:'long', year:'numeric' });
  document.getElementById('mp-month-label').textContent = mn + ' — Month Progress';
  document.getElementById('mp-pct').textContent   = monthPct + '% through the month';
  document.getElementById('mp-fill').style.width  = monthPct + '%';
  document.getElementById('mp-start').textContent = '1st';
  document.getElementById('mp-today-label').textContent = 'Today: ' + day + (day===1?'st':day===2?'nd':day===3?'rd':'th');
  document.getElementById('mp-end').textContent   = totalDays + 'th';

  // Categorise
  const recInc = entries.filter(e => e.type === 'recurring-income');
  const recExp = entries.filter(e => e.type === 'recurring-expense');
  const otInc  = entries.filter(e => e.type === 'income');
  const otExp  = entries.filter(e => e.type === 'expense');

  // This month's one-time
  const tmOtInc = otInc.filter(e => { const d = new Date(e.date+'T00:00:00'); return d >= start && d <= end; });
  const tmOtExp = otExp.filter(e => { const d = new Date(e.date+'T00:00:00'); return d >= start && d <= end; });

  // Monthly totals
  const recIncMo = recInc.reduce((a,e) => a + e.monthlyAmount, 0);
  const recExpMo = recExp.reduce((a,e) => a + e.monthlyAmount, 0);
  const otIncMo  = tmOtInc.reduce((a,e) => a + e.amount, 0);
  const otExpMo  = tmOtExp.reduce((a,e) => a + e.amount, 0);
  const totalIncMo = recIncMo + otIncMo;
  const totalExpMo = recExpMo + otExpMo;
  const netMo      = totalIncMo - totalExpMo;

  // Done / left (recurring)
  let recIncDone=0, recExpDone=0, recIncLeft=0, recExpLeft=0;
  recInc.forEach(e => {
    const st = effectiveStatus(e), oSF = occurrencesSoFar(e), oT = occurrencesTotal(e), oL = Math.max(0,oT-oSF);
    if (st==='done'||st==='paid') { recIncDone += e.monthlyAmount; }
    else if (st==='partial') { recIncDone += oSF*e.amount; recIncLeft += oL*e.amount; }
    else { recIncLeft += e.monthlyAmount; }
  });
  recExp.forEach(e => {
    const st = effectiveStatus(e), oSF = occurrencesSoFar(e), oT = occurrencesTotal(e), oL = Math.max(0,oT-oSF);
    if (st==='done'||st==='paid') { recExpDone += e.monthlyAmount; }
    else if (st==='partial') { recExpDone += oSF*e.amount; recExpLeft += oL*e.amount; }
    else { recExpLeft += e.monthlyAmount; }
  });

  // Done / left (one-time)
  const otIncDone = tmOtInc.filter(e => new Date(e.date+'T00:00:00') <= now).reduce((a,e)=>a+e.amount,0);
  const otExpDone = tmOtExp.filter(e => new Date(e.date+'T00:00:00') <= now).reduce((a,e)=>a+e.amount,0);
  const otIncLeft = tmOtInc.filter(e => new Date(e.date+'T00:00:00') >  now).reduce((a,e)=>a+e.amount,0);
  const otExpLeft = tmOtExp.filter(e => new Date(e.date+'T00:00:00') >  now).reduce((a,e)=>a+e.amount,0);

  const totalIncDone = recIncDone + otIncDone;
  const totalExpDone = recExpDone + otExpDone;
  const totalIncLeft = recIncLeft + otIncLeft;
  const totalExpLeft = recExpLeft + otExpLeft;

  // ── Projected bank balance ──────────────────────────────────────────────
  // If a snapshot exists, replay all cash flows since snapshot time → now.
  // This means the balance automatically advances each day without user input.
  let bankBal;
  const noteEl = document.getElementById('bal-note');
  if (meta.bankBalance != null && meta.bankSet) {
    const snapTime = new Date(meta.bankSet);
    bankBal = projectBalance(meta.bankBalance, snapTime, now, entries);
    const setOn = snapTime.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
    const setAt = snapTime.toLocaleTimeString('en-US', { hour:'numeric', minute:'2-digit' });
    noteEl.textContent = `snapshot set ${setOn} at ${setAt} — auto-updating daily`;
  } else {
    bankBal = totalIncDone - totalExpDone;
    noteEl.textContent = 'estimated from entries — set your actual balance above to start tracking';
  }

  // ── Forward simulation for "safe to spend" ─────────────────────────────
  function futureDates(entry) {
    const dates = [], freq = entry.freq;
    const sd = entry.date ? new Date(entry.date+'T00:00:00') : start;
    const tomorrow = new Date(now); tomorrow.setDate(tomorrow.getDate()+1); tomorrow.setHours(0,0,0,0);
    if (freq === 'monthly') {
      const d = new Date(now.getFullYear(), now.getMonth(), sd.getDate());
      if (d > now && d <= end) dates.push(d);
    } else if (freq === 'biweekly') {
      let c = new Date(sd);
      while (c <= now) c.setDate(c.getDate()+14);
      while (c <= end) { if (c > now) dates.push(new Date(c)); c.setDate(c.getDate()+14); }
    } else if (freq === 'daily') {
      let c = new Date(tomorrow);
      while (c <= end) { dates.push(new Date(c)); c.setDate(c.getDate()+1); }
    } else if (freq === 'weekly') {
      const days = entry.days||[], c = new Date(tomorrow);
      while (c <= end) { if (days.includes(c.getDay())) dates.push(new Date(c)); c.setDate(c.getDate()+1); }
    }
    return dates;
  }

  const cashEvents = [];
  recInc.forEach(e => futureDates(e).forEach(d => cashEvents.push({ date:d, amount: e.amount  })));
  recExp.forEach(e => futureDates(e).forEach(d => cashEvents.push({ date:d, amount:-e.amount  })));
  tmOtInc.filter(e => new Date(e.date+'T00:00:00') > now).forEach(e => cashEvents.push({ date:new Date(e.date+'T00:00:00'), amount: e.amount  }));
  tmOtExp.filter(e => new Date(e.date+'T00:00:00') > now).forEach(e => cashEvents.push({ date:new Date(e.date+'T00:00:00'), amount:-e.amount  }));

  const byDay = {};
  cashEvents.forEach(ev => {
    const k = ev.date.toDateString();
    if (!byDay[k]) byDay[k] = { date:ev.date, income:0, expense:0 };
    if (ev.amount > 0) byDay[k].income += ev.amount; else byDay[k].expense += Math.abs(ev.amount);
  });
  let running = bankBal, minBal = bankBal;
  Object.values(byDay).sort((a,b)=>a.date-b.date).forEach(d => {
    running += d.income; running -= d.expense;
    if (running < minBal) minBal = running;
  });
  const spendingLeft = Math.max(0, minBal);

  // Update DOM
  const balEl = document.getElementById('bal-amount');
  balEl.textContent = fmt(bankBal);
  balEl.className   = 'balance-amount ' + (bankBal >= 0 ? 'green' : 'red');
  document.getElementById('bal-spending-left').textContent = fmt(spendingLeft);
  document.getElementById('bal-inc-left').textContent      = '+' + fmt(totalIncLeft);
  document.getElementById('bal-exp-left').textContent      = '-' + fmt(totalExpLeft);
  document.getElementById('bal-inc-done').textContent      = '+' + fmt(totalIncDone);
  document.getElementById('bal-exp-done').textContent      = '-' + fmt(totalExpDone);

  document.getElementById('s-income').textContent     = fmt(totalIncMo);
  document.getElementById('s-income-sub').textContent = fmt(totalIncDone)+' received · '+fmt(totalIncLeft)+' coming';
  document.getElementById('s-expense').textContent    = fmt(totalExpMo);
  document.getElementById('s-expense-sub').textContent= fmt(totalExpDone)+' paid · '+fmt(totalExpLeft)+' due';
  const netEl = document.getElementById('s-net');
  netEl.textContent  = (netMo>=0?'+':'-') + fmt(netMo);
  netEl.className    = 'card-value ' + (netMo>=0?'green':'red');
  document.getElementById('s-net-card').className = 'summary-card net ' + (netMo>=0?'pos':'neg');
  document.getElementById('s-spending').textContent = fmt(spendingLeft);

  // Split rows
  let incR='';
  recInc.forEach(e => { incR += splitRow(e.description, e.monthlyAmount, 'green', scheduleLabel(e.freq,e.days)); });
  if (tmOtInc.length) incR += splitRow('One-time Income', otIncMo, 'green', tmOtInc.length+' entr'+(tmOtInc.length===1?'y':'ies'));
  if (!incR) incR = emptyRow('No income entries');
  incR += splitRow('Total', totalIncMo, 'green', '', true);
  document.getElementById('inc-split-rows').innerHTML = incR;

  let expR='';
  recExp.forEach(e => { expR += splitRow(e.description, e.monthlyAmount, 'red', scheduleLabel(e.freq,e.days)); });
  if (tmOtExp.length) expR += splitRow('One-time Expenses', otExpMo, 'red', tmOtExp.length+' entr'+(tmOtExp.length===1?'y':'ies'));
  if (!expR) expR = emptyRow('No expense entries');
  expR += splitRow('Total', totalExpMo, 'red', '', true);
  document.getElementById('exp-split-rows').innerHTML = expR;

  renderCharts(entries, totalIncMo, totalExpMo, recExpMo, otExpMo, recExp, tmOtExp);

  const recAll = [...recInc,...recExp];
  document.getElementById('recurring-tbody').innerHTML = recAll.length
    ? recAll.map(e => recurringRow(e)).join('')
    : '<tr class="empty-row"><td colspan="7">No recurring entries yet.</td></tr>';

  const otAll = [...tmOtInc,...tmOtExp].sort((a,b)=>new Date(b.date)-new Date(a.date));
  document.getElementById('onetime-tbody').innerHTML = otAll.length
    ? otAll.map(e => oneTimeRow(e)).join('')
    : '<tr class="empty-row"><td colspan="5">No one-time entries this month.</td></tr>';
}

function emptyRow(msg) {
  return `<div style="color:var(--text3);font-family:'IBM Plex Mono',monospace;font-size:.75rem;padding:10px 0">${msg}</div>`;
}
function splitRow(label, amt, color, sub, isTotal=false) {
  return `<div class="split-row-item${isTotal?' total':''}">
    <div><div class="sri-label" style="${isTotal?'color:var(--text)':''}">${label}</div>
    ${sub?`<div style="font-family:'IBM Plex Mono',monospace;font-size:.65rem;color:var(--text3)">${sub}</div>`:''}</div>
    <div class="sri-amt ${color}">${isTotal?(amt>=0?'+':'-'):''}${fmt(amt)}</div>
  </div>`;
}

// ══════════════════════════════════════════════════════
// ROW RENDERERS
// ══════════════════════════════════════════════════════
function recurringRow(e) {
  const st  = effectiveStatus(e);
  const oSF = occurrencesSoFar(e), oT = occurrencesTotal(e);
  const isInc = e.type === 'recurring-income';
  const stCls = st==='done'||st==='paid'?'status-done':st==='partial'?'status-partial':st==='unpaid'?'status-unpaid':'status-pending';
  const manual = getManualStatus(e.id);
  return `<tr>
    <td style="font-weight:600">${e.description}</td>
    <td><span class="type-badge ${isInc?'badge-rec-income':'badge-rec-expense'}">${isInc?'REC INCOME':'REC EXPENSE'}</span></td>
    <td class="mono" style="font-size:.75rem;color:var(--text2)">${scheduleLabel(e.freq,e.days)}</td>
    <td class="${isInc?'amount-pos':'amount-neg'}">${isInc?'+':'-'}${fmt(e.monthlyAmount)}</td>
    <td class="mono" style="font-size:.75rem;color:var(--text2)">${oSF}/${oT}</td>
    <td><span class="status-badge ${stCls}">${st.charAt(0).toUpperCase()+st.slice(1)}</span></td>
    <td><div class="override-btns">
      <button class="override-btn${manual==='paid'?' active-paid':''}" onclick="setManualStatus(${e.id},'paid')">✓ Paid</button>
      <button class="override-btn${manual==='unpaid'?' active-unpaid':''}" onclick="setManualStatus(${e.id},'unpaid')">✗ Unpaid</button>
      ${manual?`<button class="override-btn" onclick="setManualStatus(${e.id},null)">Auto</button>`:''}
      <button class="delete-btn" onclick="deleteEntry(${e.id})">✕</button>
    </div></td>
  </tr>`;
}

function oneTimeRow(e) {
  const isInc = e.type === 'income';
  return `<tr>
    <td class="mono" style="font-size:.78rem;color:var(--text2)">${fmtDate(e.date)}</td>
    <td style="font-weight:600">${e.description}</td>
    <td><span class="type-badge ${isInc?'badge-income':'badge-expense'}">${isInc?'INCOME':'EXPENSE'}</span></td>
    <td class="${isInc?'amount-pos':'amount-neg'}">${isInc?'+':'-'}${fmt(e.amount)}</td>
    <td><button class="delete-btn" onclick="deleteEntry(${e.id})">✕</button></td>
  </tr>`;
}

// ══════════════════════════════════════════════════════
// CHARTS
// ══════════════════════════════════════════════════════
let barCI=null, donutCI=null;
function renderCharts(entries, totalIncMo, totalExpMo, recExpMo, otExpMo, recExp, otExpEntries) {
  const GRID='rgba(255,255,255,0.04)', TICK={color:'#555',font:{family:'IBM Plex Mono',size:10}};
  if (barCI)   { barCI.destroy();   barCI=null; }
  if (donutCI) { donutCI.destroy(); donutCI=null; }
  const recIncMo = entries.filter(e=>e.type==='recurring-income').reduce((a,e)=>a+e.monthlyAmount,0);
  const otIncMo  = totalIncMo - recIncMo;
  barCI = new Chart(document.getElementById('barChart').getContext('2d'), {
    type:'bar',
    data:{ labels:['One-time','Recurring'], datasets:[
      { label:'Income',   data:[otIncMo, recIncMo], backgroundColor:'rgba(74,222,128,.7)', borderRadius:4 },
      { label:'Expenses', data:[otExpMo, recExpMo], backgroundColor:'rgba(248,113,113,.7)', borderRadius:4 }
    ]},
    options:{ responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ labels:{ color:'#888', font:{ family:'IBM Plex Mono', size:11 }}}},
      scales:{ x:{ grid:{color:GRID}, ticks:TICK }, y:{ grid:{color:GRID}, ticks:{...TICK,callback:v=>'$'+v} }}}
  });
  const dl=[], dd=[], dc=['#f87171','#60a5fa','#c084fc','#fbbf24','#4ade80','#fb923c','#a78bfa','#34d399'];
  recExp.forEach(e=>{ if(e.monthlyAmount>0){dl.push(e.description); dd.push(e.monthlyAmount);} });
  if (otExpMo > 0) { dl.push('One-time'); dd.push(otExpMo); }
  if (dd.length) {
    donutCI = new Chart(document.getElementById('donutChart').getContext('2d'), {
      type:'doughnut',
      data:{ labels:dl, datasets:[{ data:dd, backgroundColor:dc.slice(0,dd.length), borderWidth:0, hoverOffset:6 }]},
      options:{ responsive:true, maintainAspectRatio:false, cutout:'65%',
        plugins:{ legend:{ position:'right', labels:{color:'#888',font:{family:'IBM Plex Mono',size:10},padding:12}},
          tooltip:{ callbacks:{ label:ctx=>`${ctx.label}: ${fmt(ctx.raw)} (${((ctx.raw/totalExpMo)*100).toFixed(1)}%)`}}}}
    });
  }
}

// ══════════════════════════════════════════════════════
// REPORT
// ══════════════════════════════════════════════════════
let currentFilter = 'all';
function setFilter(f, btn) {
  currentFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderReport();
}
function renderReport() {
  const all      = load();
  const filtered = currentFilter === 'all' ? all : all.filter(e => e.type === currentFilter);
  document.getElementById('report-tbody').innerHTML = filtered.length
    ? [...filtered].sort((a,b)=>new Date(b.date)-new Date(a.date)).map(e => {
        const isInc = e.type==='income'||e.type==='recurring-income';
        const bCls  = e.type==='income'?'badge-income':e.type==='expense'?'badge-expense':e.type==='recurring-income'?'badge-rec-income':'badge-rec-expense';
        const bTxt  = e.type==='income'?'INCOME':e.type==='expense'?'EXPENSE':e.type==='recurring-income'?'REC INCOME':'REC EXPENSE';
        return `<tr>
          <td class="mono" style="font-size:.78rem;color:var(--text2)">${fmtDate(e.date)}</td>
          <td style="font-weight:600">${e.description}</td>
          <td><span class="type-badge ${bCls}">${bTxt}</span></td>
          <td class="mono" style="font-size:.75rem;color:var(--text2)">${e.freq?scheduleLabel(e.freq,e.days):'One-time'}</td>
          <td class="${isInc?'amount-pos':'amount-neg'}">${isInc?'+':'-'}${fmt(e.amount)}</td>
          <td class="${isInc?'amount-pos':'amount-neg'}">${e.monthlyAmount?fmt(e.monthlyAmount):'—'}</td>
          <td><button class="delete-btn" onclick="deleteEntry(${e.id});renderReport()">✕</button></td>
        </tr>`;
      }).join('')
    : '<tr class="empty-row"><td colspan="7">No entries found.</td></tr>';
}

// ══════════════════════════════════════════════════════
// INVESTMENTS
// ══════════════════════════════════════════════════════
const ASSETS = {
  'BTC-USD': { name:'Bitcoin',              ticker:'BTC', icon:'₿',   desc:'High volatility crypto. Highest potential gains, highest risk. Best for money you can afford to lose.', rank:1 },
  'VOO':     { name:'Vanguard S&P 500',     ticker:'VOO', icon:'S&P', desc:'Tracks 500 largest US companies. The gold standard — low fees, historically ~10% annual return.', rank:2 },
  'QQQ':     { name:'Nasdaq 100 ETF',       ticker:'QQQ', icon:'NDX', desc:'Top 100 non-financial Nasdaq stocks. Heavy tech (Apple, Nvidia, Microsoft). Higher growth than VOO.', rank:3 },
  'GLD':     { name:'SPDR Gold ETF',        ticker:'GLD', icon:'Au',  desc:'Tracks physical gold price. Inflation hedge. Strong performer in economic uncertainty.', rank:4 },
  'VNQ':     { name:'Vanguard Real Estate', ticker:'VNQ', icon:'RE',  desc:'Real estate investment trusts. ~4% dividend yield. Steady income that beats savings accounts.', rank:5 },
};
const ASSET_KEYS = Object.keys(ASSETS);
let livePrices = {}, miniCharts = {};

async function loadInvestmentPrices() {
  const label = document.getElementById('inv-last-updated');
  if (label) label.textContent = '// fetching live prices…';

  async function fetchSymbol(sym) {
    const url  = `https://query1.finance.yahoo.com/v8/finance/chart/${sym}?interval=1d&range=7d`;
    const urls = [
      url,
      `https://corsproxy.io/?${encodeURIComponent(url)}`,
      `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
    ];
    for (const u of urls) {
      try {
        const res    = await fetch(u, { headers:{ Accept:'application/json' }});
        const json   = await res.json();
        const data   = json.contents ? JSON.parse(json.contents) : json;
        const result = data?.chart?.result?.[0];
        if (!result) continue;
        const meta      = result.meta;
        const closes    = result.indicators?.quote?.[0]?.close || [];
        const price     = meta.regularMarketPrice || meta.chartPreviousClose || 0;
        const prevClose = meta.chartPreviousClose  || meta.previousClose      || price;
        const change    = price - prevClose;
        const changePct = prevClose ? (change / prevClose) * 100 : 0;
        return { price, change, changePct, history: closes.filter(p => p != null) };
      } catch(e) { continue; }
    }
    return null;
  }

  const results = await Promise.all(ASSET_KEYS.map(s => fetchSymbol(s)));
  let anyFetched = false;
  ASSET_KEYS.forEach((sym,i) => { if (results[i]) { livePrices[sym]=results[i]; anyFetched=true; }});
  if (label) label.textContent = anyFetched
    ? `// prices updated ${new Date().toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'})}`
    : '// could not load live prices';
  renderInvestments();
}

function addInvestment() {
  const symbol = document.getElementById('inv-asset').value;
  const amount = parseFloat(document.getElementById('inv-amount').value);
  const date   = document.getElementById('inv-date').value || today();
  const price  = parseFloat(document.getElementById('inv-price').value);
  if (!amount||amount<=0) { alert('Enter the amount invested ($).'); return; }
  if (!price||price<=0)   { alert('Enter the price per unit at purchase.'); return; }
  const inv = loadInv();
  inv.push({ id:Date.now(), symbol, amount, date, buyPrice:price, units:amount/price });
  saveInv(inv);
  document.getElementById('inv-amount').value = '';
  document.getElementById('inv-price').value  = '';
  flash('flash-investment');
  renderInvestments();
}

function deleteInvestment(id) {
  if (!confirm('Remove this investment?')) return;
  saveInv(loadInv().filter(i => i.id !== id));
  renderInvestments();
}

function renderInvestments() {
  const investments = loadInv();
  const hasHoldings = investments.length > 0;

  const holding = {};
  ASSET_KEYS.forEach(s => { holding[s] = { totalInvested:0, totalUnits:0 }; });
  investments.forEach(inv => {
    if (holding[inv.symbol]) {
      holding[inv.symbol].totalInvested += inv.amount;
      holding[inv.symbol].totalUnits    += inv.units;
    }
  });
  ASSET_KEYS.forEach(s => {
    const lp = livePrices[s], h = holding[s];
    h.currentValue = lp ? h.totalUnits * lp.price : h.totalInvested;
    h.gainLoss     = h.currentValue - h.totalInvested;
    h.returnPct    = h.totalInvested > 0 ? (h.gainLoss / h.totalInvested) * 100 : 0;
  });

  const totalInvested = ASSET_KEYS.reduce((a,s)=>a+holding[s].totalInvested,0);
  const totalCurrent  = ASSET_KEYS.reduce((a,s)=>a+holding[s].currentValue,0);
  const totalGain     = totalCurrent - totalInvested;
  const totalReturn   = totalInvested > 0 ? (totalGain/totalInvested)*100 : 0;

  const summBar = document.getElementById('inv-summary-bar');
  if (summBar) {
    summBar.style.display = hasHoldings ? 'flex' : 'none';
    if (hasHoldings) {
      document.getElementById('inv-total-invested').textContent = fmt(totalInvested);
      const cvEl = document.getElementById('inv-current-val'); cvEl.textContent=fmt(totalCurrent); cvEl.style.color=totalGain>=0?'var(--green)':'var(--red)';
      const glEl = document.getElementById('inv-gain-loss');   glEl.textContent=(totalGain>=0?'+':'-')+fmt(totalGain); glEl.style.color=totalGain>=0?'var(--green)':'var(--red)';
      const rpEl = document.getElementById('inv-return-pct');  rpEl.textContent=(totalReturn>=0?'+':'')+totalReturn.toFixed(2)+'%'; rpEl.style.color=totalReturn>=0?'var(--green)':'var(--red)';
    }
  }

  const withH    = ASSET_KEYS.filter(s=>holding[s].totalInvested>0).sort((a,b)=>holding[b].currentValue-holding[a].currentValue);
  const withoutH = ASSET_KEYS.filter(s=>holding[s].totalInvested===0).sort((a,b)=>ASSETS[a].rank-ASSETS[b].rank);
  const sorted   = [...withH, ...withoutH];

  Object.values(miniCharts).forEach(c => { try { c.destroy(); } catch(e){} });
  miniCharts = {};

  const grid = document.getElementById('inv-cards-grid');
  if (!grid) return;
  grid.innerHTML = '';

  sorted.forEach(symbol => {
    const asset = ASSETS[symbol], h = holding[symbol], lp = livePrices[symbol];
    const hasThis   = h.totalInvested > 0;
    const rankIdx   = withoutH.indexOf(symbol);
    const rankLabel = (!hasThis && rankIdx >= 0) ? `#${rankIdx+1} recommended` : '';
    const price     = lp?.price     ?? null;
    const changePct = lp?.changePct ?? null;
    const changeAmt = lp?.change    ?? null;
    const history   = lp?.history   ?? [];
    const priceStr  = price!=null ? fmt(price) : '--';
    const changeStr = changePct!=null ? `${changePct>=0?'▲':'▼'} ${Math.abs(changePct).toFixed(2)}% today` : '--';
    const changeCls = changePct!=null ? (changePct>=0?'up':'down') : '';
    const gainCls   = h.gainLoss>=0 ? 'inv-gain-pos' : 'inv-gain-neg';

    const rightHTML = hasThis
      ? `<div class="inv-holding-block">Invested<br><span class="inv-holding-val">${fmt(h.totalInvested)}</span><br>Value now<br><span class="inv-holding-val ${gainCls}">${fmt(h.currentValue)}</span><br>Return<br><span class="${gainCls}">${(h.gainLoss>=0?'+':'-')+fmt(h.gainLoss)} &nbsp;${(h.returnPct>=0?'+':'')+h.returnPct.toFixed(2)}%</span></div>`
      : `<div class="inv-card-desc">${asset.desc}</div>`;

    const card = document.createElement('div');
    card.className = `inv-card ${hasThis?'has-holding':'no-holding'}`;
    card.innerHTML = `
      <div class="inv-card-left">
        ${rankLabel ? `<div class="inv-card-rank">${rankLabel}</div>` : ''}
        <div class="inv-card-icon-badge">${asset.icon}</div>
        <div class="inv-card-name">${asset.name}</div>
        <div class="inv-card-ticker">${asset.ticker}</div>
        <div class="inv-card-price">${priceStr}</div>
        <div class="inv-card-change ${changeCls}">${changeStr}</div>
      </div>
      <div class="inv-card-chart"><canvas id="mini-${symbol}"></canvas></div>
      <div class="inv-card-right">${rightHTML}</div>`;
    grid.appendChild(card);

    // Chart
    let pts = history.length >= 2 ? history : null;
    if (!pts) {
      const base = (price??100) - (changeAmt??0)*5;
      pts = Array.from({length:7}, (_,i) => parseFloat((base + (changeAmt??0)*i*(0.4+Math.random()*0.6)).toFixed(4)));
      if (price != null) pts[pts.length-1] = price;
    }
    const canvas = document.getElementById(`mini-${symbol}`);
    if (canvas) {
      const ctx = canvas.getContext('2d');
      const grad = ctx.createLinearGradient(0,0,0,120);
      grad.addColorStop(0, 'rgba(74,222,128,0.28)');
      grad.addColorStop(1, 'rgba(74,222,128,0.00)');
      miniCharts[symbol] = new Chart(ctx, {
        type:'line',
        data:{ labels:pts.map((_,i)=>i), datasets:[{ data:pts, borderColor:'#4ade80', borderWidth:2.5, pointRadius:0, fill:true, backgroundColor:grad, tension:0.45 }]},
        options:{ responsive:true, maintainAspectRatio:false, animation:{duration:600},
          plugins:{ legend:{display:false}, tooltip:{enabled:true, callbacks:{label:c=>fmt(c.raw)}}},
          scales:{ x:{display:false}, y:{display:false} }}
      });
      canvas.style.filter = 'drop-shadow(0 0 7px rgba(74,222,128,0.6))';
    }
  });

  const tableSection = document.getElementById('inv-table-section');
  const tbody        = document.getElementById('inv-holdings-tbody');
  if (tableSection && tbody) {
    tableSection.style.display = hasHoldings ? 'block' : 'none';
    tbody.innerHTML = [...investments].sort((a,b)=>new Date(b.date)-new Date(a.date)).map(inv => {
      const asset     = ASSETS[inv.symbol] || { name:inv.symbol, icon:'--' };
      const lp        = livePrices[inv.symbol];
      const curPrice  = lp?.price ?? null;
      const curValue  = curPrice!=null ? inv.units*curPrice : null;
      const gl        = curValue!=null ? curValue-inv.amount : null;
      const ret       = gl!=null ? (gl/inv.amount)*100 : null;
      const cls       = gl!=null ? (gl>=0?'amount-pos':'amount-neg') : '';
      return `<tr>
        <td><span class="inv-card-icon-badge" style="font-size:.6rem">${asset.icon}</span> ${asset.name}</td>
        <td class="mono" style="font-size:.78rem;color:var(--text2)">${fmtDate(inv.date)}</td>
        <td class="amount-neg">-${fmt(inv.amount)}</td>
        <td class="mono" style="font-size:.78rem">${fmt(inv.buyPrice)}</td>
        <td class="mono" style="font-size:.78rem;color:var(--text2)">${inv.units.toFixed(6)}</td>
        <td class="mono" style="font-size:.78rem">${curPrice!=null?fmt(curPrice):'--'}</td>
        <td class="${cls}">${curValue!=null?fmt(curValue):'--'}</td>
        <td class="${cls}">${gl!=null?(gl>=0?'+':'-')+fmt(gl):'--'}</td>
        <td class="${cls}">${ret!=null?(ret>=0?'+':'')+ret.toFixed(2)+'%':'--'}</td>
        <td><button class="delete-btn" onclick="deleteInvestment(${inv.id})">✕</button></td>
      </tr>`;
    }).join('');
  }
}

// ══════════════════════════════════════════════════════
// GOALS
// ══════════════════════════════════════════════════════
const loadGoals = () => JSON.parse(localStorage.getItem('bw_goals') || '[]');
const saveGoals = d => localStorage.setItem('bw_goals', JSON.stringify(d));

// Calculate required payment per period to hit target by deadline
function calcGoalPayment(target, freq, deadlineStr) {
  const now      = new Date();
  const deadline = new Date(deadlineStr + 'T00:00:00');
  const msLeft   = deadline - now;
  if (msLeft <= 0) return null;
  const daysLeft = msLeft / 86400000;
  if (freq === 'daily')   return target / daysLeft;
  if (freq === 'weekly')  return target / (daysLeft / 7);
  if (freq === 'monthly') return target / (daysLeft / 30.44);
  return null;
}

function updateGoalPreview() {
  const target   = parseFloat(document.getElementById('goal-target').value) || 0;
  const deadline = document.getElementById('goal-date').value;
  const freq     = document.getElementById('goal-freq').value;
  const el       = document.getElementById('goal-preview-val');
  if (!target || !deadline) { el.textContent = '--'; return; }
  const pmt = calcGoalPayment(target, freq, deadline);
  if (!pmt || pmt <= 0) { el.textContent = 'past date'; el.style.color='var(--red)'; return; }
  const freqLabel = freq === 'daily' ? '/day' : freq === 'weekly' ? '/week' : '/month';
  el.textContent  = fmt(pmt) + freqLabel;
  el.style.color  = 'var(--green)';
}

function addGoal() {
  const name     = document.getElementById('goal-name').value.trim();
  const target   = parseFloat(document.getElementById('goal-target').value);
  const deadline = document.getElementById('goal-date').value;
  const freq     = document.getElementById('goal-freq').value;
  if (!name)              { alert('Enter a goal name.'); return; }
  if (!target || target <= 0) { alert('Enter a target amount.'); return; }
  if (!deadline)          { alert('Pick a goal date.'); return; }
  const pmt = calcGoalPayment(target, freq, deadline);
  if (!pmt || pmt <= 0)   { alert('Goal date must be in the future.'); return; }
  const goals = loadGoals();
  goals.push({ id: Date.now(), name, target, deadline, freq, payment: pmt, saved: 0, checkIns: [] });
  saveGoals(goals);
  document.getElementById('goal-name').value   = '';
  document.getElementById('goal-target').value = '';
  document.getElementById('goal-date').value   = '';
  document.getElementById('goal-preview-val').textContent = '--';
  flash('flash-goal');
  renderGoals();
  renderDashboard();
}

function deleteGoal(id) {
  if (!confirm('Delete this goal?')) return;
  saveGoals(loadGoals().filter(g => g.id !== id));
  renderGoals();
  renderDashboard();
}

// Check in: mark this period's payment as made
// Stores a checkin with today's date so we only allow one per period
function checkInGoal(id) {
  const goals = loadGoals();
  const g     = goals.find(g => g.id === id);
  if (!g) return;
  const todayStr   = today();
  const periodKey  = getPeriodKey(g.freq, todayStr);
  const alreadyDid = g.checkIns.some(c => c.period === periodKey);
  if (alreadyDid) {
    // Undo the checkin
    g.checkIns = g.checkIns.filter(c => c.period !== periodKey);
    g.saved    = Math.max(0, g.saved - g.payment);
  } else {
    g.checkIns.push({ period: periodKey, date: todayStr, amount: g.payment });
    g.saved += g.payment;
  }
  saveGoals(goals);
  renderGoals();
  renderDashboard(); // balance updates since goal checkin affects bank balance
}

// Period key so we only allow one checkin per day/week/month
function getPeriodKey(freq, dateStr) {
  const d = new Date(dateStr + 'T00:00:00');
  if (freq === 'daily')   return dateStr;
  if (freq === 'monthly') return `${d.getFullYear()}-${d.getMonth()+1}`;
  if (freq === 'weekly') {
    // ISO week number
    const jan1  = new Date(d.getFullYear(), 0, 1);
    const week  = Math.ceil(((d - jan1) / 86400000 + jan1.getDay() + 1) / 7);
    return `${d.getFullYear()}-W${week}`;
  }
  return dateStr;
}

function isCheckedInToday(goal) {
  return goal.checkIns.some(c => c.period === getPeriodKey(goal.freq, today()));
}

function renderGoalCard(g, compact=false) {
  const now        = new Date();
  const deadline   = new Date(g.deadline + 'T00:00:00');
  const daysLeft   = Math.ceil((deadline - now) / 86400000);
  const pct        = Math.min(100, (g.saved / g.target) * 100);
  const isComplete = g.saved >= g.target;
  const isOverdue  = daysLeft < 0 && !isComplete;
  const isUrgent   = daysLeft <= 14 && daysLeft >= 0 && !isComplete;
  const checkedIn  = isCheckedInToday(g);
  const freqLabel  = g.freq === 'daily' ? 'day' : g.freq === 'weekly' ? 'week' : 'month';

  // Recalculate payment from remaining
  const remaining  = Math.max(0, g.target - g.saved);
  const pmt        = g.payment; // always show the original payment set at creation

  let cardCls = 'goal-card';
  let badge   = `<span class="goal-badge goal-badge-active">ACTIVE</span>`;
  if (isComplete) { cardCls += ' complete'; badge = `<span class="goal-badge goal-badge-complete">COMPLETE ✓</span>`; }
  else if (isOverdue) { cardCls += ' overdue'; badge = `<span class="goal-badge goal-badge-overdue">OVERDUE</span>`; }
  else if (isUrgent)  { cardCls += ' urgent';  badge = `<span class="goal-badge goal-badge-urgent">URGENT</span>`; }

  const daysStr   = isOverdue ? `<span style="color:var(--red)">${Math.abs(daysLeft)} days overdue</span>`
                              : `<span style="color:${isUrgent?'var(--yellow)':'var(--text)'}">${daysLeft} days left</span>`;
  const fillColor = isComplete ? 'var(--green)' : isOverdue ? 'var(--red)' : isUrgent ? 'var(--yellow)' : 'var(--blue)';

  return `<div class="${cardCls}">
    <div class="goal-card-left">
      <div style="display:flex;align-items:center;gap:10px">${badge}<div class="goal-title">${g.name}</div></div>
      <div class="goal-meta">
        <div class="goal-meta-item">Due: <span>${fmtDate(g.deadline)}</span></div>
        <div class="goal-meta-item">${daysStr}</div>
        <div class="goal-meta-item">Saved: <span style="color:var(--green)">${fmt(g.saved)}</span> / <span>${fmt(g.target)}</span></div>
        ${!isComplete ? `<div class="goal-meta-item">Need: <span style="color:var(--blue)">${fmt(pmt)}/${freqLabel}</span></div>` : ''}
        <div class="goal-meta-item">Check-ins: <span>${g.checkIns.length}</span></div>
      </div>
      <div class="goal-progress-wrap">
        <div class="goal-progress-track"><div class="goal-progress-fill" style="width:${pct}%;background:${fillColor}"></div></div>
        <div class="goal-progress-label">${pct.toFixed(1)}% saved${isComplete?' — goal reached!':''}</div>
      </div>
    </div>
    <div class="goal-card-right">
      <div class="goal-amount-big ${isComplete?'complete':''}">${fmt(g.target)}</div>
      ${!isComplete ? `<button class="goal-checkin-btn${checkedIn?' checked':''}" onclick="checkInGoal(${g.id})">
        ${checkedIn ? '✓ Paid this '+freqLabel : '+ Mark paid this '+freqLabel}
      </button>` : `<div style="font-family:'IBM Plex Mono',monospace;font-size:.72rem;color:var(--green)">🎉 reached!</div>`}
      <button class="goal-delete-btn" onclick="deleteGoal(${g.id})">delete</button>
    </div>
  </div>`;
}

function renderGoals() {
  const goals = loadGoals();
  // Full goals page
  const grid  = document.getElementById('goals-grid');
  const empty = document.getElementById('goals-empty');
  if (grid) {
    if (goals.length === 0) {
      grid.innerHTML = '';
      if (empty) empty.style.display = 'block';
    } else {
      if (empty) empty.style.display = 'none';
      grid.innerHTML = goals.map(g => renderGoalCard(g)).join('');
    }
  }
  // Dashboard summary — only active/urgent goals
  const dashSection = document.getElementById('dash-goals-section');
  const dashGrid    = document.getElementById('dash-goals-grid');
  if (dashSection && dashGrid) {
    const active = goals.filter(g => g.saved < g.target);
    dashSection.style.display = goals.length > 0 ? 'block' : 'none';
    dashGrid.innerHTML = active.length > 0
      ? active.map(g => renderGoalCard(g, true)).join('')
      : `<div style="font-family:'IBM Plex Mono',monospace;font-size:.78rem;color:var(--text3);padding:16px 0">All goals complete!</div>`;
  }
}

// Total goal checkins made AFTER snapshot for balance projection
function goalCheckInsAfterSnap(snapMs) {
  const goals = loadGoals();
  let total = 0;
  goals.forEach(g => {
    g.checkIns.forEach(c => {
      // checkin date as ms (use noon to avoid timezone issues)
      const cMs = new Date(c.date + 'T12:00:00').getTime();
      if (cMs > snapMs) total += c.amount;
    });
  });
  return total;
}

// ══════════════════════════════════════════════════════
// INIT
// ══════════════════════════════════════════════════════
document.addEventListener('DOMContentLoaded', () => {
  ['i-date','e-date','ri-date','re-date','inv-date'].forEach(id => {
    const el = document.getElementById(id); if (el) el.value = today();
  });
  renderDashboard();
  renderGoals();
  loadInvestmentPrices();
});
</script>
</body>
</html>
